<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Scope - Test de Bases de Datos</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #666;
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .db-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .db-info {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f1f1f1;
            font-weight: bold;
        }
        tr:hover {
            background: #f9f9f9;
        }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .log-entry {
            margin: 2px 0;
            line-height: 1.4;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-info { color: #9cdcfe; }
    </style>
  </head>
  <body>
    <div class="container">
        <h1>üîç Activity Scope - Test de Bases de Datos</h1>
        
        <div style="margin: 20px 0;">
            <button id="test-all-dbs">üöÄ Probar Todas las Bases de Datos</button>
            <button id="clear-logs">üßπ Limpiar Logs</button>
        </div>

        <h2>üìä Estado de las Bases de Datos</h2>
        
        <!-- Roster DB -->
        <div class="db-section">
            <h3>1. Roster_VLC1.db</h3>
            <div id="roster-status" class="db-info">
                <span class="status">‚è≥ Pendiente</span>
            </div>
            <div id="roster-data"></div>
        </div>

        <!-- Stow Rates DB -->
        <div class="db-section">
            <h3>2. Stow_Rates.db</h3>
            <div id="stow-rates-status" class="db-info">
                <span class="status">‚è≥ Pendiente</span>
            </div>
            <div id="stow-rates-data"></div>
        </div>

        <!-- Analisis Cart User DB -->
        <div class="db-section">
            <h3>3. Analisis_Cart_User.db</h3>
            <div id="cart-analysis-status" class="db-info">
                <span class="status">‚è≥ Pendiente</span>
            </div>
            <div id="cart-analysis-data"></div>
        </div>

        <h2>üìù Logs de Ejecuci√≥n</h2>
        <div class="log-container" id="logs"></div>
    </div>

    <script type="module">
        let logs = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ timestamp, message, type });
            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            const logsContainer = document.getElementById('logs');
            logsContainer.innerHTML = logs.map(log => 
                `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        async function testAllDatabases() {
            addLog('üöÄ Iniciando prueba de bases de datos...', 'info');
            
            // Obtener configuraci√≥n
            const config = await window.api.getConfig();
            const dbPaths = config.db_paths || [];
            
            addLog(`üìÅ Rutas de DB configuradas: ${dbPaths.length}`, 'info');
            dbPaths.forEach(path => addLog(`   - ${path}`, 'info'));

            // Probar cada base de datos
            await testRosterDB(dbPaths);
            await testStowRatesDB(dbPaths);
            await testCartAnalysisDB(dbPaths);
            
            addLog('‚úÖ Prueba de bases de datos completada', 'success');
        }

        async function testRosterDB(dbPaths) {
            addLog('', 'info');
            addLog('‚ïê‚ïê‚ïê Probando Roster_VLC1.db ‚ïê‚ïê‚ïê', 'info');
            
            for (const dbPath of dbPaths) {
                try {
                    const rosterPath = `${dbPath}Roster_VLC1.db`;
                    addLog(`üîç Buscando en: ${rosterPath}`, 'info');
                    
                    const exists = await window.api.fileExists(rosterPath);
                    if (!exists) {
                        addLog(`‚ö†Ô∏è No encontrado en esta ruta`, 'error');
                        continue;
                    }
                    
                    addLog(`‚úÖ Base de datos encontrada!`, 'success');
                    
                    // Consultar datos
                    const query = "SELECT * FROM roster_vlc1 WHERE employee_status = 'A' LIMIT 5";
                    const results = await window.api.queryDatabase(rosterPath, query);
                    
                    addLog(`‚úÖ Consulta exitosa. Registros obtenidos: ${results.length}`, 'success');
                    
                    // Mostrar resultados
                    document.getElementById('roster-status').innerHTML = 
                        `<span class="status success">‚úÖ Conectado - ${results.length} registros de muestra</span>`;
                    
                    if (results.length > 0) {
                        const tableHtml = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Login</th>
                                        <th>Turno</th>
                                        <th>Manager</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(emp => `
                                        <tr>
                                            <td>${emp.employee_id || 'N/A'}</td>
                                            <td>${emp.employee_name || 'N/A'}</td>
                                            <td>${emp.login || 'N/A'}</td>
                                            <td>${emp.shift || 'N/A'}</td>
                                            <td>${emp.manager || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                        document.getElementById('roster-data').innerHTML = tableHtml;
                    }
                    
                    break;
                } catch (error) {
                    addLog(`‚ùå Error: ${error.message}`, 'error');
                    document.getElementById('roster-status').innerHTML = 
                        `<span class="status error">‚ùå Error: ${error.message}</span>`;
                }
            }
        }

        async function testStowRatesDB(dbPaths) {
            addLog('', 'info');
            addLog('‚ïê‚ïê‚ïê Probando Stow_Rates.db ‚ïê‚ïê‚ïê', 'info');
            
            for (const dbPath of dbPaths) {
                try {
                    const stowRatesPath = `${dbPath}Stow_Rates.db`;
                    addLog(`üîç Buscando en: ${stowRatesPath}`, 'info');
                    
                    const exists = await window.api.fileExists(stowRatesPath);
                    if (!exists) {
                        addLog(`‚ö†Ô∏è No encontrado en esta ruta`, 'error');
                        continue;
                    }
                    
                    addLog(`‚úÖ Base de datos encontrada!`, 'success');
                    
                    // Consultar cada tabla
                    const eachRates = await window.api.queryDatabase(stowRatesPath, "SELECT * FROM stow_each_rates LIMIT 3");
                    const palletRates = await window.api.queryDatabase(stowRatesPath, "SELECT * FROM stow_pallet_rates LIMIT 3");
                    const effortRates = await window.api.queryDatabase(stowRatesPath, "SELECT * FROM rate_por_esfuerzo LIMIT 3");
                    
                    addLog(`‚úÖ stow_each_rates: ${eachRates.length} registros`, 'success');
                    addLog(`‚úÖ stow_pallet_rates: ${palletRates.length} registros`, 'success');
                    addLog(`‚úÖ rate_por_esfuerzo: ${effortRates.length} registros`, 'success');
                    
                    document.getElementById('stow-rates-status').innerHTML = 
                        `<span class="status success">‚úÖ Conectado - 3 tablas le√≠das correctamente</span>`;
                    
                    document.getElementById('stow-rates-data').innerHTML = `
                        <div style="margin-top: 10px;">
                            <strong>Tablas encontradas:</strong><br>
                            ‚Ä¢ stow_each_rates: ${eachRates.length} registros de muestra<br>
                            ‚Ä¢ stow_pallet_rates: ${palletRates.length} registros de muestra<br>
                            ‚Ä¢ rate_por_esfuerzo: ${effortRates.length} registros de muestra
                        </div>
                    `;
                    
                    break;
                } catch (error) {
                    addLog(`‚ùå Error: ${error.message}`, 'error');
                    document.getElementById('stow-rates-status').innerHTML = 
                        `<span class="status error">‚ùå Error: ${error.message}</span>`;
                }
            }
        }

        async function testCartAnalysisDB(dbPaths) {
            addLog('', 'info');
            addLog('‚ïê‚ïê‚ïê Probando Analisis_Cart_User.db ‚ïê‚ïê‚ïê', 'info');
            
            for (const dbPath of dbPaths) {
                try {
                    const cartAnalysisPath = `${dbPath}Analisis_Cart_User.db`;
                    addLog(`üîç Buscando en: ${cartAnalysisPath}`, 'info');
                    
                    const exists = await window.api.fileExists(cartAnalysisPath);
                    if (!exists) {
                        addLog(`‚ö†Ô∏è No encontrado en esta ruta`, 'error');
                        continue;
                    }
                    
                    addLog(`‚úÖ Base de datos encontrada!`, 'success');
                    
                    // Consultar cada tabla
                    const carts = await window.api.queryDatabase(cartAnalysisPath, "SELECT * FROM user_stow_carts LIMIT 3");
                    const weight = await window.api.queryDatabase(cartAnalysisPath, "SELECT * FROM employee_halfhour_weight LIMIT 3");
                    
                    addLog(`‚úÖ user_stow_carts: ${carts.length} registros`, 'success');
                    addLog(`‚úÖ employee_halfhour_weight: ${weight.length} registros`, 'success');
                    
                    document.getElementById('cart-analysis-status').innerHTML = 
                        `<span class="status success">‚úÖ Conectado - 2 tablas le√≠das correctamente</span>`;
                    
                    document.getElementById('cart-analysis-data').innerHTML = `
                        <div style="margin-top: 10px;">
                            <strong>Tablas encontradas:</strong><br>
                            ‚Ä¢ user_stow_carts: ${carts.length} registros de muestra<br>
                            ‚Ä¢ employee_halfhour_weight: ${weight.length} registros de muestra
    </div>
                    `;
                    
                    break;
                } catch (error) {
                    addLog(`‚ùå Error: ${error.message}`, 'error');
                    document.getElementById('cart-analysis-status').innerHTML = 
                        `<span class="status error">‚ùå Error: ${error.message}</span>`;
                }
            }
        }

        // Event listeners
        document.getElementById('test-all-dbs').addEventListener('click', testAllDatabases);
        document.getElementById('clear-logs').addEventListener('click', () => {
            logs = [];
            updateLogsDisplay();
        });

        // Auto-ejecutar al cargar
        window.addEventListener('DOMContentLoaded', () => {
            addLog('üìÑ P√°gina cargada', 'info');
            addLog('‚ÑπÔ∏è Haz clic en "Probar Todas las Bases de Datos" para comenzar', 'info');
        });

        // Hacer accesible globalmente
        window.testAllDatabases = testAllDatabases;

        // Log inicial inmediato
        console.log("üöÄ Script de Activity Scope ejecut√°ndose...");
        console.log("üìã window.api disponible:", typeof window.api);
        console.log("üìã window.api.queryDatabase disponible:", typeof window.api?.queryDatabase);
        
        // Verificar que los botones existan
        const testButton = document.getElementById('test-all-dbs');
        const clearButton = document.getElementById('clear-logs');
        console.log("üîç Bot√≥n de test encontrado:", testButton !== null);
        console.log("üîç Bot√≥n de limpiar encontrado:", clearButton !== null);
    </script>
    
    <!-- Cargar el JS principal -->
    <script src="../js/activity-scope.js"></script>
  </body>
</html>
